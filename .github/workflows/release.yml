name: Release Binary and Container

on:
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write
  id-token: write

env:
  GO_APP_NAME: deepsight
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/deepsight

jobs:
  determine_version:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.versify.outputs.should_release }}
      new_version: ${{ steps.versify.outputs.new_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Versify
        run: |
          curl -L "https://github.com/OpScaleHub/versify/releases/latest/download/versify-linux-amd64.tar.gz" -o versify.tar.gz
          tar -xzvf versify.tar.gz
          chmod +x versify-linux-amd64
          sudo mv versify-linux-amd64 /usr/local/bin/versify

      - name: Run Versify and Check Tag
        id: versify
        run: |
          VERSION=$(versify)
          echo "Proposed version: $VERSION"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "new_version=$VERSION" >> $GITHUB_OUTPUT
          fi

  build_all:
    needs: determine_version
    if: needs.determine_version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: windows
            goarch: amd64
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - run: |
          go mod tidy
          go test -v ./...

      - name: Build and Package Binary (${{ matrix.goos }}/${{ matrix.goarch }})
        run: |
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} \
          go build -ldflags="-s -w" -o ${{ env.GO_APP_NAME }}-${{ matrix.goos }}-${{ matrix.goarch }} .
          ARCHIVE_FILE="${{ env.GO_APP_NAME }}-${{ matrix.goos }}-${{ matrix.goarch }}"
          if [ "${{ matrix.goos }}" = "windows" ]; then
            zip "$ARCHIVE_FILE.zip" "$ARCHIVE_FILE"
            echo "ARCHIVE_PATH=$ARCHIVE_FILE.zip" >> $GITHUB_ENV
          else
            tar -czf "$ARCHIVE_FILE.tar.gz" "$ARCHIVE_FILE"
            echo "ARCHIVE_PATH=$ARCHIVE_FILE.tar.gz" >> $GITHUB_ENV
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.GO_APP_NAME }}-${{ matrix.goos }}-${{ matrix.goarch }}
          path: ${{ env.ARCHIVE_PATH }}
          retention-days: 1

  publish_image:
    needs: determine_version
    if: needs.determine_version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set image name
        env:
          RAW_IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/deepsight
        run: echo "IMAGE_NAME=$(echo $RAW_IMAGE_NAME | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image ðŸš€
        id: build_image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ needs.determine_version.outputs.new_version }}

  create_release:
    needs: [determine_version, build_all, publish_image]
    if: needs.determine_version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.determine_version.outputs.new_version }}
          name: Release ${{ needs.determine_version.outputs.new_version }}
          generate_release_notes: true
          files: artifacts/**/*
