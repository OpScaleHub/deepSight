name: Release Binary and Container

on:
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write
  id-token: write

env:
  GO_APP_NAME: deepsight

jobs:
  determine_version:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.versify.outputs.should_release }}
      new_version: ${{ steps.versify.outputs.new_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Versify
        run: |
          curl -L "https://github.com/OpScaleHub/versify/releases/latest/download/versify-linux-amd64.tar.gz" -o versify.tar.gz
          tar -xzvf versify.tar.gz
          chmod +x versify-linux-amd64
          sudo mv versify-linux-amd64 /usr/local/bin/versify

      - name: Run Versify and Check Tag
        id: versify
        run: |
          VERSION=$(versify)
          echo "Proposed version: $VERSION"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "new_version=$VERSION" >> $GITHUB_OUTPUT
          fi

  build_all:
    needs: determine_version
    if: needs.determine_version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: windows
            goarch: amd64
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - run: |
          go mod tidy
          go test -v ./...

      - id: package
        name: Build and Package Binary (${{ matrix.goos }}/${{ matrix.goarch }})
        run: |
          set -e
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} \
          go build -ldflags="-s -w" -o ${{ env.GO_APP_NAME }}-${{ matrix.goos }}-${{ matrix.goarch }} .
          ARCHIVE_FILE="${{ env.GO_APP_NAME }}-${{ matrix.goos }}-${{ matrix.goarch }}"
          if [ "${{ matrix.goos }}" = "windows" ]; then
            zip "$ARCHIVE_FILE.zip" "$ARCHIVE_FILE"
            # Expose as a step output so later steps can access it in expressions
            echo "archive_path=$ARCHIVE_FILE.zip" >> $GITHUB_OUTPUT
          else
            tar -czf "$ARCHIVE_FILE.tar.gz" "$ARCHIVE_FILE"
            echo "archive_path=$ARCHIVE_FILE.tar.gz" >> $GITHUB_OUTPUT
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.GO_APP_NAME }}-${{ matrix.goos }}-${{ matrix.goarch }}
          path: ${{ steps.package.outputs.archive_path }}
          retention-days: 1

  publish_image:
    needs: determine_version
    permissions:
      contents: read
      packages: write
      # This is used to complete the identity challenge
      # with sigstore/fulcio when running outside of PRs.
      id-token: write
    if: needs.determine_version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image name
        env:
          RAW_IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/deepsight
        run: |
          # Lowercase the image name and export it for subsequent steps
          echo "IMAGE_NAME=$(echo \"$RAW_IMAGE_NAME\" | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build and push Docker image ðŸš€
        id: build_image
        run: |
          set -euo pipefail
          # Ensure IMAGE_NAME contains no stray quote characters which would break docker tag parsing
          CLEAN_IMAGE_NAME=$(echo "$IMAGE_NAME" | tr -d '"')
          echo "Building and pushing image: $CLEAN_IMAGE_NAME"
          docker buildx build --platform linux/amd64,linux/arm64 \
            -f ./Dockerfile \
            -t "${CLEAN_IMAGE_NAME}:latest" \
            -t "${CLEAN_IMAGE_NAME}:${{ needs.determine_version.outputs.new_version }}" \
            --push .

  create_release:
    needs: [determine_version, build_all, publish_image]
    if: needs.determine_version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.determine_version.outputs.new_version }}
          name: Release ${{ needs.determine_version.outputs.new_version }}
          generate_release_notes: true
          files: artifacts/**/*
